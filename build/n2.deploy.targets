<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="3.5">
	<!-- Deploy -->

	<PropertyGroup>
		<Framework-DeployFolder>$(DeployFolder)\$(DeployPrefix)Framework</Framework-DeployFolder>
		<Framework-NugetFolder>$(DeployFolder)\$(DeployPrefix)Framework_Nuget</Framework-NugetFolder>
		<Management-NugetFolder>$(DeployFolder)\$(DeployPrefix)Management_Nuget</Management-NugetFolder>
		<Library-NugetFolder>$(DeployFolder)\$(DeployPrefix)Library_Nuget</Library-NugetFolder>
		<SQLite-NugetFolder>$(DeployFolder)\$(DeployPrefix)SQLite_Nuget</SQLite-NugetFolder>
		<Razor-NugetFolder>$(DeployFolder)\$(DeployPrefix)Razor_Nuget</Razor-NugetFolder>
		<Windsor2-NugetFolder>$(DeployFolder)\$(DeployPrefix)Windsor2_Nuget</Windsor2-NugetFolder>
		<Windsor3-NugetFolder>$(DeployFolder)\$(DeployPrefix)Windsor3_Nuget</Windsor3-NugetFolder>
	</PropertyGroup>

	<Target Name="Framework-Deploy" DependsOnTargets="Framework-CreateItemGroups">
		<Copy SourceFiles="@(Framework-BinFiles)" DestinationFolder="$(Framework-DeployFolder)\bin" />
		<Copy SourceFiles="@(Framework-EditFiles)" DestinationFolder="$(Framework-DeployFolder)\N2\%(RecursiveDir)" SkipUnchangedFiles="true" />
		<Copy SourceFiles="@(TextFiles)" DestinationFolder="$(Framework-DeployFolder)" />
	</Target>
  
	<Target Name="Library-NuGet">
		<ItemGroup>
			<libraryNuspec Include="$(BuildFolder)\Nuget\Library\N2.Library.nuspec" />
		</ItemGroup>
		<Copy SourceFiles="@(libraryNuspec)" DestinationFolder="$(Library-NugetFolder)" />
		<FileUpdate Files="$(Library-NugetFolder)\N2.Library.nuspec" Regex="{Version}" ReplacementText="$(Version)" />

		<Exec Command="$(BuildFolder)\lib\NuGet.exe pack -Symbols -OutputDirectory .." WorkingDirectory="$(Library-NugetFolder)\" />
	</Target>

	<Target Name="SQLite-NuGet">
		<ItemGroup>
			<sqliteNuspec Include="$(BuildFolder)\Nuget\SQLite\N2.SQLite.nuspec" />
		</ItemGroup>
		<Copy SourceFiles="@(sqliteNuspec)" DestinationFolder="$(SQLite-NugetFolder)" />
		<FileUpdate Files="$(SQLite-NugetFolder)\N2.SQLite.nuspec" Regex="{Version}" ReplacementText="$(Version)" />

		<Exec Command="$(BuildFolder)\lib\NuGet.exe pack -Symbols -OutputDirectory .." WorkingDirectory="$(SQLite-NugetFolder)\" />
	</Target>

	<Target Name="Windsor2-NuGet">
		<ItemGroup>
			<windsor2Nuspec Include="$(BuildFolder)\Nuget\IoC.Windsor2\N2.Windsor2.nuspec" />
		</ItemGroup>
		<Copy SourceFiles="@(windsor2Nuspec)" DestinationFolder="$(Windsor2-NugetFolder)" />
		<FileUpdate Files="$(Windsor2-NugetFolder)\N2.Windsor2.nuspec" Regex="{Version}" ReplacementText="$(Version)" />

		<Exec Command="$(BuildFolder)\lib\NuGet.exe pack -Symbols -OutputDirectory .." WorkingDirectory="$(Windsor2-NugetFolder)\" />
	</Target>

	<Target Name="Windsor3-NuGet">
		<ItemGroup>
			<windsor3Nuspec Include="$(BuildFolder)\Nuget\IoC.Windsor3\N2.Windsor3.nuspec" />
		</ItemGroup>
		<Copy SourceFiles="@(windsor3Nuspec)" DestinationFolder="$(Windsor3-NugetFolder)" />
		<FileUpdate Files="$(Windsor3-NugetFolder)\N2.Windsor3.nuspec" Regex="{Version}" ReplacementText="$(Version)" />

		<Exec Command="$(BuildFolder)\lib\NuGet.exe pack -Symbols -OutputDirectory .." WorkingDirectory="$(Windsor3-NugetFolder)\" />
	</Target>

	<Target Name="Razor-NuGet">
		<ItemGroup>
			<razorNuspec Include="$(BuildFolder)\Nuget\Razor\N2.Razor.nuspec" />
		</ItemGroup>
		<Copy SourceFiles="@(razorNuspec)" DestinationFolder="$(Razor-NugetFolder)" />
		<FileUpdate Files="$(Razor-NugetFolder)\N2.Razor.nuspec" Regex="{Version}" ReplacementText="$(Version)" />

		<Exec Command="$(BuildFolder)\lib\NuGet.exe pack -Symbols -OutputDirectory .." WorkingDirectory="$(Razor-NugetFolder)\" />
	</Target>

	<Target Name="Management-NuGet" DependsOnTargets="Library-NuGet;SQLite-NuGet;Razor-NuGet;Management-CreateZip">
		<ItemGroup>
			<managementNuspec Include="$(BuildFolder)\Nuget\Management\N2.Management.nuspec" />
		</ItemGroup>
		<Copy SourceFiles="@(managementNuspec)" DestinationFolder="$(Management-NugetFolder)" />
		<FileUpdate Files="$(Management-NugetFolder)\N2.Management.nuspec" Regex="{Version}" ReplacementText="$(Version)" />

		<Exec Command="$(BuildFolder)\lib\NuGet.exe pack -Symbols -OutputDirectory .." WorkingDirectory="$(Management-NugetFolder)\" />
	</Target>

	<Target Name="Framework-NuGet" DependsOnTargets="Management-NuGet;Framework-CreateTextFiles">
		<ItemGroup>
			<frameworkNuspec Include="$(BuildFolder)\Nuget\Framework\N2.Cms.nuspec" />
		</ItemGroup>
		<Copy SourceFiles="@(frameworkNuspec)" DestinationFolder="$(Framework-NugetFolder)" />
		<FileUpdate Files="$(Framework-NugetFolder)\N2.Cms.nuspec" Regex="{Version}" ReplacementText="$(Version)" />

		<Exec Command="$(BuildFolder)\lib\NuGet.exe pack -Symbols -OutputDirectory .." WorkingDirectory="$(Framework-NugetFolder)\" />
	</Target>

	<Target Name="Management-CreateZip" DependsOnTargets="Framework-CreateItemGroups-EditFiles">
		<!-- Using DotNetZip since MSBuild Community Tasks Zip doesn't include directory entries -->
		<Copy SourceFiles="@(Framework-EditFiles)" DestinationFolder="$(Management-DeployFolder)\N2\%(RecursiveDir)" SkipUnchangedFiles="true" />
		<Delete Files="$(Management-NugetFolder)\content\N2\N2.zip" Condition="Exists('$(Management-NugetFolder)\content\N2\N2.zip')" />
		<Copy SourceFiles="$(Management-DeployFolder)\N2\web.config"	DestinationFolder="$(Management-NugetFolder)\content\N2\" />
		<Exec Command="$(BuildFolder)\lib\BuildSupport.exe ZipDirectory &quot;$(Management-NugetFolder)\content\N2\N2.zip&quot; &quot;$(Management-DeployFolder)\N2&quot; &quot;N2&quot;" />
  </Target>
  
	<Target Name="Framework-CreateTextFiles">
    <Copy SourceFiles="@(TextFiles)" DestinationFolder="$(Framework-NugetFolder)\Content\N2\" />
  </Target>

  
	<Target Name="Framework-ZipDeploy" DependsOnTargets="Framework-Deploy;Framework-Zip" />

	<Target Name="Framework-Zip">
		<ItemGroup>
			<ZipDeploy-Framework Include="$(Framework-DeployFolder)\**" />
		</ItemGroup>

		<Error Condition="'@(ZipDeploy-Framework)' == ''" Text="Nothing in '$(Framework-DeployFolder)'. Do deploy first." />

		<Zip Files="@(ZipDeploy-Framework)"       WorkingDirectory="$(Framework-DeployFolder).."              ZipFileName="$(Framework-DeployFolder).zip" />
	</Target>

	<Target Name="Deploy-OpenAll">
		<ItemGroup>
			<openLine Include="$(DeployPrefix)Dinamico_Mvc\N2CMS\Dinamico.csproj" />
			<openLine Include="pause" />
			<openLine Include="$(DeployPrefix)Example_CS\CSharp_Example.sln" />
			<openLine Include="pause" />
			<openLine Include="$(DeployPrefix)Example_Mvc\Mvc_Example.sln" />
			<openLine Include="pause" />
			<openLine Include="$(DeployPrefix)Example_VB\VisualBasic_Example.sln" />
			<openLine Include="pause" />
			<openLine Include="cd /d $(DeployPrefix)Source\build" />
			<openLine Include="cmd /c build.bat /target:PrepareDependencies" />
			<openLine Include="cd ..\.." />
			<openLine Include="$(DeployPrefix)Source\N2.Everything.sln" />
			<openLine Include="pause" />
			<openLine Include="copy $(DeployPrefix)Templates_Mvc\Libraries\System.Data.SQLite.dll $(DeployPrefix)Templates_Mvc\N2CMS\bin\" />
			<openLine Include="$(DeployPrefix)Templates_Mvc\N2CMS\N2.Templates.Mvc.sln" />
			<openLine Include="pause" />
			<openLine Include="copy $(DeployPrefix)Templates_WebForms\Libraries\System.Data.SQLite.dll $(DeployPrefix)Templates_WebForms\N2CMS\bin\" />
			<openLine Include="$(DeployPrefix)Templates_WebForms\N2CMS\N2.Templates.sln" />
		</ItemGroup>
		<WriteLinesToFile Lines="@(openLine)" File="$(DeployFolder)\OpenAll.bat" Overwrite="true" />
	</Target>

	<Target Name="Deploy-BuildAll">
		<ItemGroup>
			<buildLine Include="msbuild $(DeployPrefix)Dinamico_Mvc\N2CMS\Dinamico.csproj" />
			<buildLine Include="msbuild $(DeployPrefix)Example_CS\CSharp_Example.sln" />
			<buildLine Include="msbuild $(DeployPrefix)Example_Mvc\Mvc_Example.sln" />
			<buildLine Include="msbuild $(DeployPrefix)Example_VB\VisualBasic_Example.sln" />
			<buildLine Include="cd /d $(DeployPrefix)Source\build" />
			<buildLine Include="cmd /c build.bat /target:PrepareDependencies" />
			<buildLine Include="cd ..\.." />
			<buildLine Include="msbuild $(DeployPrefix)Source\N2.Everything.sln" />
			<buildLine Include="copy $(DeployPrefix)Templates_Mvc\Libraries\System.Data.SQLite.dll $(DeployPrefix)Templates_Mvc\N2CMS\bin\" />
			<buildLine Include="msbuild $(DeployPrefix)Templates_Mvc\N2CMS\N2.Templates.Mvc.sln" />
			<buildLine Include="copy $(DeployPrefix)Templates_WebForms\Libraries\System.Data.SQLite.dll $(DeployPrefix)Templates_WebForms\N2CMS\bin\" />
			<buildLine Include="msbuild $(DeployPrefix)Templates_WebForms\N2CMS\N2.Templates.sln" />
		</ItemGroup>
		<WriteLinesToFile Lines="@(buildLine)" File="$(DeployFolder)\BuildAll.bat" Overwrite="true" />
	</Target>

	<Target Name="Build-NuGet" DependsOnTargets="Framework-NuGet;Library-NuGet;SQLite-NuGet;Razor-NuGet;Dinamico-NuGet;Windsor2-NuGet;Windsor3-NuGet">
	</Target>

	<Target Name="Publish-NuGet" DependsOnTargets="Build-NuGet">
		<ItemGroup>
			<nugetPackages Include="$(DeployFolder)\*.nupkg" />
		</ItemGroup>
		<!--<Message Text="$(BuildFolder)\lib\NuGet.exe Push %(nugetPackages.Identity)" />-->
		<Exec Command="$(BuildFolder)\lib\NuGet.exe Push %(nugetPackages.Identity) -s http://symbols.localhost/ sl4Hdp0mtwh0t" />
	</Target>
</Project>